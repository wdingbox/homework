<html>

<head>
  <title>SGift</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <META name="viewport" content="width=device-witdh, initial-scale=1, maximum-scale=1, user-scale=0">

  <link rel="stylesheet" xhref="images/common.css" type="text/css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

  <script src="spiritualGiftAccessment_Key.json.js?x=1"></script>
  <script src="spiritualGiftAccessment_Desc.json.js?x=1"></script>


  <style>
    @media print {
      footer {
        page-break-after: always;
      }
    }

    #menu {
      position: fixed;
      top: 0px;
      right: 10px;
      width: 100%;
      background-color: lightgrey;
    }

    .portalBtn {
      float: right;
    }

    #CopyTextToClipboard {
      visibility: visible;
      position: fixed;
      left: -130px;
    }

    .choiceBtn,
    .btn {
      background-color: #f0f0f0;
    }

    #ctr .btn {
      font-size: 22px;
    }

    .hili {
      background-color: chartreuse;
      border-radius: 50%;
      border: 1px solid black;
    }

    .mark {
      background-color: lavender;
    }

    .max {
      background-color: yellowgreen;
    }

    .denote {
      font-size: 11px;
    }

    #result {
      height: 900px;
    }

    table {
      background-color: mintcream;
      border-collapse: collapse;

    }

    table.assessmentTable {
      margin-top: 100px;
    }
  </style>
  <script>
    $(function () {
      gen_tab();
    });

    function gen_tab() {
      var radios = `
          <button class='choiceBtn' title='Always, definiely true.'>3</<button>
          <button class='choiceBtn' title='Most of the time, usually true.'>2</<button>
          <button class='choiceBtn' title='Some of the time, once in a while.'>1</<button>
          <button class='choiceBtn hili' title='Not at all, never.'>0</button>
            <a class='denote'></a>`;
      var str = ""
      spiritualGiftAssessment_Desc.forEach(function (val, i) {
        //console.log(val);
        str += `<tr><td class='num'>${1 + i}</td><td>${val}<br>${radios}</td></tr>`;
      });


      var stb = `
      <table class='assessmentTable' border='1'>
        <caption>Discover U â€“ S.H.A.P.E. Spiritual Gifts Assessment.</caption>
        <thead><tr><th>#</th><th>
          Self-Assessment</th></tr></thead>
        <tbody>
          ${str}
        </tbody>
        </table>`;

      var tab = $("#holder").append(stb);
      $(tab).find(".choiceBtn").bind("click", function () {
        $(this).parent().find(".hili").removeClass("hili");
        $(this).addClass("hili");
        var tit = $(this).attr("title");

        $(this).parent().find(".denote").slideUp(1);
        $(this).parent().find(".denote").text(tit);
        $(this).parent().find(".denote").slideDown(1000);

        //$(this).parent().find(".denote").slideUp(3000);

        //$(this).parentsUntil("table").find(".mark").removeClass("mark");
        $(this).parent().prev().addClass("mark");
      });
      $(tab).find(".num").bind("click", function () {
        $(this).toggleClass("mark");
      });
    };///////////////


    function get_choice_arr() {
      var arr = [];
      $(".hili").each(function (i) {
        var selv = $(this).text().trim();
        //console.log(i, selv);
        arr.push(parseInt(selv));
      });
      return arr;
    }
    function calc_choice_arr(arr) {
      var EvalArr = [];
      for (var j = 0; j < arr.length; j++) {
        var sum = 0;
        for (var k = 0; k < arr.length; k += 19) {
          if (k >= arr.length) conitune;
          var m = j + k;
          if (m >= arr.length) {
            //console.log("-------", m)
            j = arr.length + 1;
            break;
          }
          //console.log(m)
          sum += arr[m];
        };
        if (j >= arr.length) break;
        //console.log("sum ===", sum);
        EvalArr.push(sum);
      }
      return EvalArr;
    }
    function evaluateAssessment() {
      var arr = get_choice_arr();
      var evr = calc_choice_arr(arr);
      gen_result(arr, evr);
    };

    function get_max(arr) {
      var max = -1;
      arr.forEach(function (val) {
        if (val > max) max = val;
      });
      return max;
    }

    function gen_result(Charr, Evarr) {
      var str = "", max = get_max(Evarr);
      var keys = Object.keys(spiritualGiftAssessment_Key);
      Evarr.forEach(function (val, i) {
        //console.log(val);
        var maxMark = "", notes = "";
        if (max == val && val > 0) {
          maxMark = "class='max' title='strong gift'";
          notes = "Top Spiritual Gift";
        }

        str += `<tr ><td>${1 + i}</td><td>${keys[i]}</td><td>${spiritualGiftAssessment_Key[keys[i]]}</td><td ${maxMark}>${val}</td><td>${notes}</td></tr>`;
      });


      var stb = `
      <table border='1' id="calcScore">
        <caption> Spiritual Gifts Assessment Key</caption>
        <thead><tr><th>#</th><th>Key</th><th>Desc</th><th>Score</th><th>Notes</th></tr></thead>
        <tbody>
          ${str}
        </tbody>
        </table>`;

      //stb += `Copy your Choice Data:<br><textarea readonly>${JSON.stringify(Charr)}</textarea>`;

      $("#result").html(stb).find("tr").bind("click", function () {
        $(this).toggleClass("max");
      });
    }

    function importFunction() {
      if(false == confirm("To load data will erase your current data!\nAre you sure to continue?")){
        return;
      }
      var val = localStorage.lastSpirit;
      if(!val){
        val = prompt("Paste your choice data", "");
      }
      if (!val) return;
      var arr = JSON.parse(val);
      console.log(arr);
      if (arr.length <= 100) {
        return;
      }
 
      $(".hili").removeClass("hili");
      $("table tbody").find("tr").each(function (i) {
        var val = parseInt(arr[i]);
        var idx = 3 - val;
        $(this).find(`.choiceBtn:eq(${idx})`).addClass("hili");
      });
      $("#result").html("");
    }
    function exportFunction() {
      if(false == confirm("Are you sure to save current choice data?")){
        return;
      }
      $("#CopyTextToClipboard").val("");
      var arr = get_choice_arr();
      var str = JSON.stringify(arr);
      localStorage.lastSpirit = str;
      if(localStorage.lastSpirit && localStorage.lastSpirit.length>100){
        return;
      }
      var ret = prompt("Copy your choice data to save anywhere for reuse.", str);
      console.log(ret);
      if (!ret) return;
      $("#CopyTextToClipboard").val(str);
      $("#CopyTextToClipboard").select();
      document.execCommand("copy");
    }
  </script>
</head>

<body>
  <div id="menu">
    <input id="CopyTextToClipboard"></input>
    <button class="portalBtn" onclick="importFunction()" title="Load your last saved data.">Load</button>
    <button class="portalBtn" onclick="exportFunction()" title="Save your choice data.">Save</button>
  </div>

  <div id="holder"></div>
  <hr />
  <div id="ctr">
    <button onclick="evaluateAssessment();" class="btn">Calculate the Assessment Scores</button><br>
  </div>
  <hr  style="page-break-before: always" />
  <div id="result"></div>

</body>

</html>